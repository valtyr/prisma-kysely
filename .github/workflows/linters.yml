name: ðŸ˜µâ€ðŸ’« Sanity checks
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main
permissions:
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v6

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc

      - name: ðŸ— Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸ§ª Run tests
        run: bun run test

  typecheck:
    name: ðŸ¤“ Type checker
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v6

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc

      - name: ðŸ— Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸ¤“ Run type checker
        run: bun run typecheck

  lint:
    name: ðŸ‘®â€â™‚ï¸ Linters and formatters
    runs-on: ubuntu-latest
    permissions:
      checks: write # Allow creating checks
      contents: read
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v6

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc

      - name: ðŸ— Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: ðŸ“¦ Install dependencies
        run: bun install

      - name: ðŸ‘®â€â™‚ï¸ Run linters
        run: bun run lint

      - name: ðŸ’… Run fixers, and check diff
        id: diffCheck
        run: bun run fix && git diff --exit-code -- ':!bun.lock'

      - name: ðŸ’¬ Post a check explaining the issue
        if: ${{ failure() && steps.diffCheck.conclusion == 'failure' }}
        uses: LouisBrunner/checks-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ðŸ§¹ Check all files are formatted correctly
          conclusion: failure
          output: |
            {"summary": "Hrm, seems like you don't have prettier set up properly. Make sure your editor is configured to format code automatically, and that it respects the project's prettier config. [Click here](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode) to view the Prettier extension for VS Code.\n\n> _**ðŸ’¡ Tip:**_ \n> \n> In the meantime you can run `npm run fix` and commit the changes."}
