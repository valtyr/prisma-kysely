name: 😵‍💫 Sanity checks
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main

jobs:
  test:
    name: 🧪 Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v2

      - name: 🏗 Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install

      - name: 🧪 Run tests
        run: yarn run test

  typecheck:
    name: 🤓 Type checker
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v2

      - name: 🏗 Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install

      - name: 🤓 Run type checker
        run: yarn run typecheck

  lint:
    name: 👮‍♂️ Linters and formatters
    runs-on: ubuntu-latest
    permissions:
      checks: write # Allow creating checks
      contents: read
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v2

      - name: 🏗 Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install

      - name: 👮‍♂️ Run linters
        run: yarn run lint

      - name: 💅 Run fixers, and check diff
        id: diffCheck
        run: yarn run fix && git diff --exit-code -- ':!yarn.lock'

      - name: 💬 Post a check explaining the issue
        if: ${{ failure() && steps.diffCheck.conclusion == 'failure' }}
        uses: LouisBrunner/checks-action@v1.1.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: 🧹 Check all files are formatted correctly
          conclusion: failure
          output: |
            {"summary": "Hrm, seems like you don't have prettier set up properly. Make sure your editor is configured to format code automatically, and that it respects the project's prettier config. [Click here](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode) to view the Prettier extension for VS Code.\n\n> _**💡 Tip:**_ \n> \n> In the meantime you can run `npm run fix` and commit the changes."}

  snapshot:
    name: 📸 Release a snapshot
    runs-on: ubuntu-latest
    needs: [test, typecheck, lint]
    if: github.ref != 'refs/heads/master'
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v2

      - name: 🏗 Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install

      - name: 🪤 Create .npmrc
        run: |
          cat << EOF > "$HOME/.npmrc"
            //registry.npmjs.org/:_authToken=$NPM_TOKEN
          EOF
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 🆓 Release snapshot
        run: |
          yarn build
          yarn changeset version --snapshot snapshot
          yarn changeset publish --tag snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📸 Snapshot version
        run: |
          echo "### 👋 Snapshot version" >> $GITHUB_STEP_SUMMARY
          echo "If you've added a changeset to your pull request, then a snapshot release with" >> $GITHUB_STEP_SUMMARY
          echo "your latest changes will have been created with its version number reflected below:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package name    | Version            |" >> $GITHUB_STEP_SUMMARY
          echo "| --------------- | ------------------ |" >> $GITHUB_STEP_SUMMARY
          echo "| `prisma-kysely` |  `$(jq -r .version package.json)` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This can be useful to test your changes in other repos." >> $GITHUB_STEP_SUMMARY
          echo "> _**💡 Tip:**_\n>\n> If you just see a normal version number here, that means that you haven't" >> $GITHUB_STEP_SUMMARY
          echo "> created a changeset for your PR. You can do this by running the following command:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ```bash" >> $GITHUB_STEP_SUMMARY
          echo "> yarn changeset\n> ```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> You will be prompted to choose what kind of changes you're making. In most" >> $GITHUB_STEP_SUMMARY
          echo "> cases this will be patch." >> $GITHUB_STEP_SUMMARY
